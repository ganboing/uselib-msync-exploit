#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>

#include <stdio.h>
 
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/user.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <elf.h>

#include <pthread.h>

#include "ski-barriers.h"
#include "ski-hyper.h"

extern int STD_SKI_ENABLED, STD_SKI_FORK_ENABLED, STD_SKI_WAIT_FOR_RESULTS, STD_SKI_CPU_AFFINITY, STD_SKI_HYPERCALLS, STD_SKI_SOFT_EXIT_BARRIER, STD_SKI_USER_BARRIER, STD_SKI_TOTAL_CPUS, STD_SKI_TEST_NUMBER, STD_SKI_PROFILE_ENABLED;

int ski_test_start(int current_cpu, int total_cpus, int dry_run);
void ski_test_finish(int current_cpu, int dry_run);
void hypercall_debug(int current_cpu, char *format, ...);
void hypercall_debug_quiet(int current_cpu, char *format, ...);
char* ski_parse_env(void);

#define BASE (char *) 0x60000000
#define EATFILE "TTeatfile"
#define LIBFILE "TTlib"

char *swapmem = NULL;
char *base = BASE;
int fd3;
volatile int race_start = 0;

struct libimg {
  	Elf32_Ehdr elf;
  	Elf32_Phdr ph;
};

/* the image of the evil library. */
struct libimg limg = {
  	{
  	e_ident: "\177ELF",
  	e_type: ET_EXEC,
  	e_machine: EM_386,
  	e_phoff: sizeof(Elf32_Ehdr),
  	e_ehsize: sizeof(Elf32_Ehdr),
  	e_phentsize: sizeof(Elf32_Phdr),
  	e_phnum: 1
  	},
  	{
  	p_type: PT_LOAD,
  	p_vaddr: 0,
  	p_memsz: 0
  	}
};

static void make_lib(char *name)
{
  	int libfd = open(name, O_CREAT|O_RDWR|O_TRUNC, 0700);
  	write(libfd, &limg, sizeof(limg));
  	fchmod(libfd, 0700);
}

void *thread(void *d)
{
	//while(!race_start);
	hypercall_debug_quiet(STD_SKI_CPU_AFFINITY + 1, "Child thread started pid=%d\n", (int)getpid());
	ski_test_start(STD_SKI_CPU_AFFINITY + 1, STD_SKI_TOTAL_CPUS, 0);

	if( msync(swapmem, PAGE_SIZE, MS_SYNC) < 0)
  	{
		perror("msync failed with error:");
	}
	ski_test_finish(STD_SKI_CPU_AFFINITY + 1, 0);
	hypercall_debug_quiet(STD_SKI_CPU_AFFINITY + 1, "Child finished\n");
	return NULL;
}

pthread_t msync_thd;
int main(int argc, char *argv[])
{
	if(munlockall() == -1)
	{
		fprintf(stderr, "munlockall failed reason %s\n", strerror(errno));
		return -1;
	}

	ski_parse_env();

	//dry run
	ski_test_start(STD_SKI_CPU_AFFINITY, STD_SKI_TOTAL_CPUS, 1);
	hypercall_debug_quiet(STD_SKI_CPU_AFFINITY, "Begin test parent pid %d\n", (int)getpid());

	fd3 = open(EATFILE, O_CREAT|O_RDWR|O_TRUNC, 0777);
	ftruncate(fd3, PAGE_SIZE);
	swapmem = base;
	mmap(swapmem, PAGE_SIZE, PROT_READ|PROT_WRITE, MAP_SHARED|MAP_FIXED, fd3, 0);

	close(fd3);

	pthread_create(&msync_thd, NULL, &thread, NULL);

	int ski_ret = ski_test_start(STD_SKI_CPU_AFFINITY, STD_SKI_TOTAL_CPUS, 0);
	//race_start = 1;

  	limg.ph.p_vaddr = (unsigned) swapmem;
  	limg.ph.p_memsz = PAGE_SIZE ;  make_lib(LIBFILE);

  	uselib(LIBFILE);
	ski_test_finish(STD_SKI_CPU_AFFINITY, 0);

	hypercall_debug_quiet(STD_SKI_CPU_AFFINITY, "Parent finished\n");

	pthread_join(msync_thd, NULL);

	hypercall_debug_quiet(STD_SKI_CPU_AFFINITY, (char*)"END INFO");

	return 0;
}
